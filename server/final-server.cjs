import express from 'express';
import path from 'path';
import { fileURLToPath } from 'url';
import TelegramBot from 'node-telegram-bot-api';

const TOKEN = '8428998356:AAFPu3NwVage2hHNtnTko3HOvqaogJi_e28';
const EXTERNAL_URL = 'https://mini-app-roan-nine.vercel.app';
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(express.json());
app.use(express.static(path.join(__dirname, '../dist')));

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ° Ñ polling (Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ´Ğ»Ñ Vercel)
const bot = new TelegramBot(TOKEN, { 
  polling: true 
});

// API Ğ´Ğ»Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
app.post('/api/order', (req, res) => {
  console.log('ğŸ“¦ Ğ—Ğ°ĞºĞ°Ğ· Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½:', req.body);
  
  // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Telegram
  const { products, total, contact } = req.body;
  const message = `
ğŸ›’ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°ĞºĞ°Ğ·!
    
Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹: ${products.map(p => p.name).join(', ')}
Ğ¡ÑƒĞ¼Ğ¼Ğ°: ${total} Ñ€ÑƒĞ±.
ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚: ${contact}
  `;
  
  // Ğ—ĞĞœĞ•ĞĞ˜Ğ¢Ğ• 'Ğ’ĞĞ¨_CHAT_ID' Ğ½Ğ° Ğ²Ğ°Ñˆ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ chat_id
  // Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ chat_id: Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ñƒ /start, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ:
  // https://api.telegram.org/bot8428998356:AAFPu3NwVage2hHNtnTko3HOvqaogJi_e28/getUpdates
  bot.sendMessage('1379007527', message)
    .catch(err => console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:', err));
  
  res.json({ success: true, message: 'Ğ—Ğ°ĞºĞ°Ğ· Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚' });
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° /start ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  console.log('ğŸŸ¢ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start Ğ¾Ñ‚:', chatId);
  
  const keyboard = {
    inline_keyboard: [[
      {
        text: 'ğŸ›ï¸ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ',
        web_app: { url: EXTERNAL_URL }
      }
    ]]
  };

  bot.sendMessage(chatId,
    'Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ! \n\n' +
    'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚Ğµ Ğ·Ğ°ĞºĞ°Ğ· Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ² Telegram.',
    { reply_markup: keyboard }
  ).catch(err => console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:', err));
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¸Ğ· Ğ¼Ğ¸Ğ½Ğ¸-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
bot.on('message', (msg) => {
  if (msg.web_app_data) {
    const chatId = msg.chat.id;
    const data = msg.web_app_data.data;
    
    console.log('ğŸ“¦ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¼Ğ¸Ğ½Ğ¸-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ:', data);
    
    try {
      const orderData = JSON.parse(data);
      
      // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
      bot.sendMessage(chatId, 'âœ… Ğ’Ğ°Ñˆ Ğ·Ğ°ĞºĞ°Ğ· Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚! ĞœÑ‹ ÑĞ²ÑĞ¶ĞµĞ¼ÑÑ Ñ Ğ²Ğ°Ğ¼Ğ¸ Ğ² Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ.');
      
      // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ
      const adminMessage = `
ğŸ›’ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°ĞºĞ°Ğ· Ğ¸Ğ· Ğ¼Ğ¸Ğ½Ğ¸-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ!
    
Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹: ${orderData.products.map(p => p.name).join(', ')}
Ğ¡ÑƒĞ¼Ğ¼Ğ°: ${orderData.total} Ñ€ÑƒĞ±.
ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚: ${orderData.contact}
      `;
      
      bot.sendMessage('Ğ’ĞĞ¨_CHAT_ID', adminMessage)
        .catch(err => console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ:', err));
        
    } catch (error) {
      console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:', error);
      bot.sendMessage(chatId, 'âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ·Ğ°ĞºĞ°Ğ·Ğ°.');
    }
  }
});

// SPA fallback
app.get('*', (_, res) => {
  res.sendFile(path.join(__dirname, '../dist', 'index.html'));
});

app.listen(PORT, () => {
  console.log(`âœ… Server running on port ${PORT}`);
  console.log(`ğŸŒ Web App URL: ${EXTERNAL_URL}`);
  console.log(`ğŸ¤– Bot is running in polling mode`);
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ±Ğ¾Ñ‚Ğ°
bot.on('error', (error) => {
  console.error('âŒ Telegram Bot Error:', error);
});

bot.on('polling_error', (error) => {
  console.error('âŒ Telegram Polling Error:', error);
});